function segments = setup_segments(X,Y,num_segments,total_x_grid_points)


% Do precomputations
x = linspace(min(X),max(X),total_x_grid_points);

%x = [4.8828e-09,2.27318044444444e-07,4.49753288888889e-07,6.72188533333333e-07,8.94623777777778e-07,1.11705902222222e-06,1.33949426666667e-06,1.56192951111111e-06,1.78436475555556e-06,2.0068e-06];
%y = [2.76103677047393e-08,1.99770730569969e-08,2.99402800356634e-08,3.39833429975547e-08,2.91301996432723e-08,3.38679604141834e-08,2.58788654065226e-08,3.67077021068965e-08,3.25078928907416e-08,2.38706175668463e-08];



% Get grid size
n = round(total_x_grid_points/num_segments);
m = num_segments * n;

x = linspace(min(X),max(X),m + 1);
y = interp1(X,Y,x);

segment_length = idivide(int32(total_x_grid_points), int32(num_segments));

segments = cell(num_segments,1);

y = [2.84726710869352e-08,2.66330508867823e-08,2.50816191918684e-08,2.34815224659579e-08,2.19361361176291e-08,2.30650615530424e-08,2.57708379227038e-08,2.69390728223281e-08,2.60212699818022e-08,2.3902552646326e-08,2.20715405148618e-08,2.08393764391928e-08,1.9786731285393e-08,1.91475043573889e-08,1.89448653333784e-08,1.98265678024378e-08,2.4300216731357e-08,2.89721155153098e-08,3.34920345188164e-08,3.57122476519754e-08,3.5262614118671e-08,3.32888671177828e-08,3.08025834178594e-08,2.76053147678603e-08,2.34134836813471e-08,2.64564856843003e-08,3.16056477851676e-08,3.63766332463259e-08,3.91023950682429e-08,4.01115313234666e-08,4.00640646532153e-08,3.98217823468841e-08,3.8288468460592e-08,3.48456463797506e-08,2.96597635787131e-08,2.48888749467745e-08,2.54784254474639e-08,2.82490589861681e-08,3.07035021376213e-08,3.14806092999245e-08,3.00953978264986e-08,2.75363767709124e-08,2.52039540579107e-08,2.54814221650901e-08,2.99925030254682e-08,3.28389838801102e-08,3.51306644387529e-08,3.72987825769335e-08,3.80820492948824e-08,3.6982108061879e-08,3.48754676502517e-08,3.26344246973916e-08,2.94273629817242e-08,2.68720136947006e-08,3.04139313078432e-08,3.47302637963793e-08,3.77931721017162e-08,3.98511981544109e-08,4.1418752584176e-08,4.17199468885254e-08,4.05859880990865e-08,3.90266840271091e-08,3.73779739952893e-08,3.37711624225751e-08,2.83696757301685e-08,2.42005756889663e-08,2.67411687887186e-08,3.12939695060965e-08,3.36756054751282e-08,3.41974920232704e-08,3.37872074529115e-08,3.29670256182383e-08,3.08040805611463e-08,2.78458465534592e-08,2.66499803767445e-08,3.07534895487404e-08,3.47352440714968e-08,3.75700054890925e-08,3.94422440331654e-08,4.02318309481984e-08,3.98920293221277e-08,3.87242276317546e-08,3.71973033962654e-08,3.47333052636722e-08,3.12038192642405e-08,2.69861891518648e-08,2.74823204355099e-08,3.1320403121233e-08,3.33701962729376e-08,3.45793051996433e-08,3.5680141285334e-08,3.58949146085273e-08,3.5207232900491e-08,3.39146204304267e-08,3.2122807654486e-08,2.93366149785819e-08,2.52892456282474e-08,2.19835727671683e-08,2.22701984285255e-08,2.47329209490423e-08];
x = [4.8828e-09,2.51041858585859e-08,4.53255717171717e-08,6.55469575757576e-08,8.57683434343434e-08,1.05989729292929e-07,1.26211115151515e-07,1.46432501010101e-07,1.66653886868687e-07,1.86875272727273e-07,2.07096658585859e-07,2.27318044444444e-07,2.4753943030303e-07,2.67760816161616e-07,2.87982202020202e-07,3.08203587878788e-07,3.28424973737374e-07,3.4864635959596e-07,3.68867745454545e-07,3.89089131313131e-07,4.09310517171717e-07,4.29531903030303e-07,4.49753288888889e-07,4.69974674747475e-07,4.90196060606061e-07,5.10417446464646e-07,5.30638832323232e-07,5.50860218181818e-07,5.71081604040404e-07,5.9130298989899e-07,6.11524375757576e-07,6.31745761616162e-07,6.51967147474747e-07,6.72188533333333e-07,6.92409919191919e-07,7.12631305050505e-07,7.32852690909091e-07,7.53074076767677e-07,7.73295462626263e-07,7.93516848484848e-07,8.13738234343434e-07,8.3395962020202e-07,8.54181006060606e-07,8.74402391919192e-07,8.94623777777778e-07,9.14845163636364e-07,9.35066549494949e-07,9.55287935353535e-07,9.75509321212121e-07,9.95730707070707e-07,1.01595209292929e-06,1.03617347878788e-06,1.05639486464646e-06,1.07661625050505e-06,1.09683763636364e-06,1.11705902222222e-06,1.13728040808081e-06,1.15750179393939e-06,1.17772317979798e-06,1.19794456565657e-06,1.21816595151515e-06,1.23838733737374e-06,1.25860872323232e-06,1.27883010909091e-06,1.29905149494949e-06,1.31927288080808e-06,1.33949426666667e-06,1.35971565252525e-06,1.37993703838384e-06,1.40015842424242e-06,1.42037981010101e-06,1.4406011959596e-06,1.46082258181818e-06,1.48104396767677e-06,1.50126535353535e-06,1.52148673939394e-06,1.54170812525253e-06,1.56192951111111e-06,1.5821508969697e-06,1.60237228282828e-06,1.62259366868687e-06,1.64281505454545e-06,1.66303644040404e-06,1.68325782626263e-06,1.70347921212121e-06,1.7237005979798e-06,1.74392198383838e-06,1.76414336969697e-06,1.78436475555556e-06,1.80458614141414e-06,1.82480752727273e-06,1.84502891313131e-06,1.8652502989899e-06,1.88547168484848e-06,1.90569307070707e-06,1.92591445656566e-06,1.94613584242424e-06,1.96635722828283e-06,1.98657861414141e-06,2.0068e-06];

d = x(2)-x(1);
alpha = min(2*d,10^(-8));

% Setup segments
for k = 1:num_segments
    current_segment = k;

    START = (current_segment - 1) * segment_length + 1
    END = min(START - 1 + segment_length + 1, total_x_grid_points)

    %segx = x((k-1)*n+1:k*n+1);
    %segy = y((k-1)*n+1:k*n+1);
    segx = x(START:END);
    segy = y(START:END);
    segments{k} = setup_nanostructures(segx,segy,alpha);

end