
%% Computing field for one nanowire at a time

clear; clc; close all; 

settings = {'one_nanowire','two_far_nanowires','two_close_nanowires','multiple_nanowires'};
choice = 4;

if choice == 1
    nanowires = cell(1,1);
    nanowires{1} = setup_nanowire();
elseif choice == 2
    nanowires = cell(1,1);
    nanowires{1} = setup_nanowire();
    nanowires{2} = setup_nanowire();
    nanowires{2}.xc = 7*10^(-7);
    nanowires{2}.r = 1.2*nanowires{2}.r;
elseif choice == 3
    nanowires = cell(1,1);
    nanowires{1} = setup_nanowire();
    nanowires{2} = setup_nanowire();
    nanowires{2}.r = 1.2*nanowires{2}.r;
    nanowires{2}.xc = nanowires{1}.r + nanowires{2}.r;
elseif choice == 4
    nanowires = cell(1,1);
    nanowires{1} = setup_nanowire();
    nanowires{2} = setup_nanowire();
    nanowires{2}.xc = 6*10^(-7);
    nanowires{2}.r = 1.2*nanowires{2}.r;
    nanowires{3} = setup_nanowire();
    nanowires{3}.xc = 10*10^(-7);
    nanowires{3}.r = 0.7*nanowires{2}.r;
    nanowires{4} = setup_nanowire();
    nanowires{4}.xc = 14*10^(-7);
    nanowires{4}.r = 1.1*nanowires{2}.r;

else
    disp("Please choose 1, 2, 3 or 4.")
end

for k = 1:length(nanowires)
    nanowires{k} = forward_one_nanowire(nanowires{k});
end


figure;
for k = 1:length(nanowires)
    nw = nanowires{k};
    plot(nw.x,nw.y,'r.')
    hold on
    plot(nw.x_int,nw.y_int,'b.')
    plot(nw.x_ext,nw.y_ext,'g.')
    axis equal
end
%%
X = linspace(-6,14,500)*10^(-7);
Y = linspace(0,16,500)*10^(-7);

[Xmesh,Ymesh] = meshgrid(X,Y);
combined = false;
[Etot, Htot, Einc, Hinc, Eref, Href, Escat, Hscat] = compute_2D_field(Xmesh,Ymesh,nanowires,combined);

climmaxE = -1;
climmaxH = -1;
for i = 1:3
    climmaxE = max(climmaxE,max(max(abs(Etot(:,:,i)).^2)));
    climmaxH = max(climmaxH,max(max(abs(Htot(:,:,i)).^2)));
end

var = {'x','y','z'};

figure('Renderer', 'painters', 'Position', [400 400 1000 500]);
tiledlayout(1,3,'TileSpacing','compact');
for k = 1:3
    nexttile;
    imagesc(X,Y,abs(Etot(:,:,k)).^2)
    set(gca,'YDir','normal')
    title(sprintf('$|E_%s|^2$',var{k}),'FontSize',15)
    axis equal
    axis tight
    clim([0,climmaxE]);
    hold on
    for j = 1:length(nanowires)
        nw = nanowires{j};
        %fplot(@(t) nw.r*sin(t)+nw.xc, @(t) nw.r*cos(t)+nw.r,'r-');
    end

end

c  =colorbar; 
c.Layout.Tile = 'east';

figure('Renderer', 'painters', 'Position', [400 400 1000 500]);
tiledlayout(1,3,'TileSpacing','compact');
for k = 1:3
    nexttile;
    imagesc(X,Y,abs(Htot(:,:,k)).^2)
    set(gca,'YDir','normal')
    title(sprintf('$|H_%s|^2$',var{k}),'FontSize',15)
    axis equal
    axis tight
    clim([0,climmaxH]);
    hold on
    for j = 1:length(nanowires)
        nw = nanowires{j};
        %fplot(@(t) nw.r*sin(t)+nw.xc, @(t) nw.r*cos(t)+nw.r,'r-');
    end

end

c  =colorbar; 
c.Layout.Tile = 'east';

%% Solving several nanowires at the same time

clear; clc; close all; 

nanowires = cell(1,1);
nanowires{1} = setup_nanowire();
nanowires{2} = setup_nanowire();
nanowires{2}.xc = 7*10^(-7);
nanowires{2}.r =1.2*nanowires{2}.r;

nanowires = forward_several_nanowires(nanowires);

C1_1 = nanowires{1}.C;
C2_1 = nanowires{2}.C;
D1_1 = nanowires{1}.D;
D2_1 = nanowires{2}.D;
x1 = nanowires{1}.x_int;
y2 = nanowires{2}.y_int;
%%
nanowires{2} = setup_nanowire();
nanowires{1} = setup_nanowire();
nanowires{1}.xc = 7*10^(-7);
nanowires{1}.r =1.2*nanowires{1}.r;
nanowires = forward_several_nanowires(nanowires)
C1_2 = nanowires{1}.C;
C2_2 = nanowires{2}.C;
D1_2 = nanowires{1}.D;
D2_2 = nanowires{2}.D;
max(abs(C1_1-C2_2))
max(abs(C2_1-C1_2))
max(abs(D1_1-D2_2))
max(abs(D2_1-D1_2))
%%



figure;
for k = 1:length(nanowires)
    nw = nanowires{k};
    plot(nw.x,nw.y,'r.')
    hold on
    plot(nw.x_int,nw.y_int,'b.')
    plot(nw.x_ext,nw.y_ext,'g.')
    axis equal
end

X = linspace(-6,14,100)*10^(-7);
Y = linspace(0,16,100)*10^(-7);

[Xmesh,Ymesh] = meshgrid(X,Y);
combined = true;
[Etot, Htot, Einc, Hinc, Eref, Href, Escat, Hscat] = compute_2D_field(Xmesh,Ymesh,nanowires,combined);

climmaxE = -1;
climmaxH = -1;
for i = 1:3
    climmaxE = max(climmaxE,max(max(abs(Etot(:,:,i)).^2)));
    climmaxH = max(climmaxH,max(max(abs(Htot(:,:,i)).^2)));
end

var = {'x','y','z'};

figure('Renderer', 'painters', 'Position', [400 400 1000 500]);
tiledlayout(1,3,'TileSpacing','compact');
for k = 1:3
    nexttile;
    imagesc(X,Y,abs(Etot(:,:,k)).^2)
    set(gca,'YDir','normal')
    title(sprintf('$|E_%s|^2$',var{k}),'FontSize',15)
    axis equal
    axis tight
    clim([0,climmaxE]);
    hold on
    for j = 1:length(nanowires)
        nw = nanowires{j};
        %fplot(@(t) nw.r*sin(t)+nw.xc, @(t) nw.r*cos(t)+nw.r,'r-');
    end

end

c  =colorbar; 
c.Layout.Tile = 'east';

figure('Renderer', 'painters', 'Position', [400 400 1000 500]);
tiledlayout(1,3,'TileSpacing','compact');
for k = 1:3
    nexttile;
    imagesc(X,Y,abs(Htot(:,:,k)).^2)
    set(gca,'YDir','normal')
    title(sprintf('$|H_%s|^2$',var{k}),'FontSize',15)
    axis equal
    axis tight
    clim([0,climmaxH]);
    hold on
    for j = 1:length(nanowires)
        nw = nanowires{j};
        %fplot(@(t) nw.r*sin(t)+nw.xc, @(t) nw.r*cos(t)+nw.r,'r-');
    end

end

c  =colorbar; 
c.Layout.Tile = 'east';
